<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4. Sioux Falls Example &mdash; RecursiveRouteChoice 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="5. Data Format Support" href="data_formats.html" />
    <link rel="prev" title="3. A Simple Example" href="simple_example.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            RecursiveRouteChoice
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introduction &amp; Overview:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction_install.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction_install.html#installation">2. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="simple_example.html">3. A Simple Example</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">4. Sioux Falls Example</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#efficiency">4.1. Efficiency</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="data_formats.html">5. Data Format Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../apisource/recursiveRouteChoice.html">recursiveRouteChoice package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">RecursiveRouteChoice</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active"><span class="section-number">4. </span>Sioux Falls Example</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/source/involved_example.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="sioux-falls-example">
<h1><span class="section-number">4. </span>Sioux Falls Example<a class="headerlink" href="#sioux-falls-example" title="Permalink to this heading"></a></h1>
<p>Here we present example usage for the classic Sioux Falls network, again estimating parameters
from simulated data. This is the same example appearing in the README, but we give a little more
detail.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">recursiveRouteChoice.data_loading</span> <span class="kn">import</span> <span class="n">load_tntp_node_formulation</span>
<span class="kn">from</span> <span class="nn">recursiveRouteChoice</span> <span class="kn">import</span> <span class="n">RecursiveLogitModelPrediction</span><span class="p">,</span> <span class="n">ModelDataStruct</span><span class="p">,</span> \
    <span class="n">RecursiveLogitModelEstimation</span>
<span class="kn">from</span> <span class="nn">recursiveRouteChoice</span> <span class="kn">import</span> <span class="n">optimisers</span>

<span class="c1"># DATA</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sys path is&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()))</span>
<span class="n">network_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;tests&quot;</span><span class="p">,</span> <span class="s2">&quot;docs&quot;</span><span class="p">,</span> <span class="s2">&quot;SiouxFalls_net.tntp&quot;</span><span class="p">)</span>
<span class="n">node_max</span> <span class="o">=</span> <span class="mi">24</span>  <span class="c1"># from network file</span>

</pre></div>
</div>
<p>Here we see usage of one of the convenience loader methods provided for the tntp format. Since
the network is very small and easily fits in memory, we store it in a dense representation.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span>
<span class="n">distances</span> <span class="o">=</span> <span class="n">data_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

</pre></div>
</div>
<p>This is the standardised way of passing data to the model, the network attributes are collected
into a <code class="code docutils literal notranslate"><span class="pre">ModelDataStruct</span></code> instance, alongside the corresponding incidence matrix. We then
simulate a series of observations between every origin destination pair, note that whilst this
will print there are 576 observations, there will actually be less as observations starting and
ending at the same node are omitted.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">network_struct</span> <span class="o">=</span> <span class="n">ModelDataStruct</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">incidence_mat</span><span class="p">)</span>

<span class="n">beta_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.8</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.00015</span><span class="p">])</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">RecursiveLogitModelPrediction</span><span class="p">(</span><span class="n">network_struct</span><span class="p">,</span>
                                      <span class="n">initial_beta</span><span class="o">=</span><span class="n">beta_sim</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Linear system size&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">get_exponential_utility_matrix</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># sparse sample for quick running example</span>
<span class="n">orig_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">node_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">dest_indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">orig_indices</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">%</span> <span class="n">node_max</span>
<span class="c1"># sample every OD pair once</span>
<span class="c1"># orig_indices = np.arange(0, node_max, 1)</span>
<span class="c1"># dest_indices = np.arange(0, node_max, 1)</span>
<span class="n">obs_per_pair</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>We now construct the estimation model to attempt to recover the parameters the data was simulated
with. We construct and optimiser instance, this time using L-BFGS and provide an initial iterate
for the optimisation algorithm. Note that these are of differing orders of magnitude, due to
capacity being measured on the scale of tens of thousands for Sioux Falls. Attempting to use
<code class="code docutils literal notranslate"><span class="pre">beta_est_init</span> <span class="pre">=</span> <span class="pre">[-5,</span> <span class="pre">-5]</span></code> will fail as the matrix <span class="math notranslate nohighlight">\(M\)</span> will be numerically zero,
giving rise to a degenerate solution. This case is explicitly caught as an error by the code.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span>                                  <span class="n">num_obs_per_pair</span><span class="o">=</span><span class="n">obs_per_pair</span><span class="p">,</span> <span class="n">iter_cap</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">rng_seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

<span class="n">optimiser</span> <span class="o">=</span> <span class="n">optimisers</span><span class="o">.</span><span class="n">ScipyOptimiser</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;l-bfgs-b&#39;</span><span class="p">)</span>
<span class="n">beta_est_init</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.00001</span><span class="p">]</span>
<span class="n">model_est</span> <span class="o">=</span> <span class="n">RecursiveLogitModelEstimation</span><span class="p">(</span><span class="n">network_struct</span><span class="p">,</span> <span class="n">observations_record</span><span class="o">=</span><span class="n">obs</span><span class="p">,</span>
                                          <span class="n">initial_beta</span><span class="o">=</span><span class="n">beta_est_init</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                          <span class="n">optimiser</span><span class="o">=</span><span class="n">optimiser</span><span class="p">)</span>

<span class="n">beta_est</span> <span class="o">=</span> <span class="n">model_est</span><span class="o">.</span><span class="n">solve_for_optimal_beta</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

</pre></div>
</div>
<p>Running the code, we get that on the specified seed, so the original parameters have been
recovered somewhat well. If we increase to simulating a trip between every origin and
destination, we see more accurate recovery of the parameters.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># Every second OD pair:</span>
<span class="n">beta</span> <span class="n">expected</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.8000</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0001</span><span class="p">],</span> <span class="n">beta_actual</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.021</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.000175</span><span class="p">]</span>

<span class="c1"># One simulation per OD pair:</span>
<span class="n">beta</span> <span class="n">expected</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.8000</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0001</span><span class="p">],</span> <span class="n">beta_actual</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.7963</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0002</span><span class="p">]</span>
</pre></div>
</div>
<section id="efficiency">
<h2><span class="section-number">4.1. </span>Efficiency<a class="headerlink" href="#efficiency" title="Permalink to this heading"></a></h2>
<p>Note that there are also drop in replacement classes <code class="code docutils literal notranslate"><span class="pre">recursiveRouteChoice</span>
<span class="pre">.RecursiveLogitModelEstimationSM</span></code> and <code class="code docutils literal notranslate"><span class="pre">recursiveRouteChoice</span>
<span class="pre">.RecursiveLogitModelPredictionSM</span></code> which provide identical functionality to the variants without
suffixes. These however use the Sherman-Morrison formula to solve component linear systems in a
more efficient way. This leverages the structure of the problem by noting that the change in
sub-problems for different destinations can be described in terms of a rank one update of a
destination independent matrix.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="simple_example.html" class="btn btn-neutral float-left" title="3. A Simple Example" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="data_formats.html" class="btn btn-neutral float-right" title="5. Data Format Support" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Matthew Richards.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>